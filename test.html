<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazioni imminenti</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
        }

        .card {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            max-width: 650px;
            margin: 20px auto;
            line-height: 1.5;
        }

        .controls {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button {
            margin: 5px;
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
        }

        .done {
            background: #4caf50;
            color: white;
        }

        .skip {
            background: #f44336;
            color: white;
        }

        .nav {
            background: #2196f3;
            color: white;
        }

        .note-box {
            background: #f0f0f0;
            border-radius: 6px;
            padding: 10px;
            white-space: pre-wrap;
            /* mantiene i capi riga */
            font-family: monospace;
            margin-top: 6px;
        }
    </style>
</head>

<body>

    <h1>üìÖ Prossime Prenotazioni</h1>
    <div id="output" class="card">Caricamento dati...</div>

    <div class="controls">
        <button id="prev" class="nav">‚¨ÖÔ∏è Indietro</button>
        <button id="done" class="done">‚úÖ Fatto</button>
        <button id="skip" class="skip">‚è≠Ô∏è Salta</button>
        <button id="next" class="nav">‚û°Ô∏è Avanti</button>
    </div>

    <script>
        // üîó Link CSV pubblico del tuo Google Sheets
        const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRmA9RJulshPotUfVnTtt8YInexYrPc1qvHZHVaNvgExNDctVz8OAnfB0CdphDRnzXY4pZOgsHrlWNM/pub?output=csv";

        let data = [];
        let index = 0;

        async function loadSheet() {
            const res = await fetch(sheetUrl);
            const text = await res.text();

            // üîπ Divide il file in righe
            const rows = text.trim().split("\n").map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)); // gestisce CSV con virgole nei testi

            // üîπ Salta le prime 5 righe (le intestazioni sono alla riga 6)
            const headerRowIndex = 2;
            if (rows.length <= headerRowIndex) {
                document.getElementById("output").innerHTML = "Errore: il file sembra non avere abbastanza righe.";
                return;
            }

            const headers = rows[headerRowIndex].map(h => h.trim());
            const dataRows = rows.slice(headerRowIndex + 1);

            const dateIdx = headers.findIndex(h => h.toLowerCase().includes("data prenotazione"));
            if (dateIdx === -1) {
                document.getElementById("output").innerHTML = "<b>Errore:</b> colonna 'DATA PRENOTAZIONE' non trovata.";
                return;
            }

            data = dataRows.map(r => {
                const obj = {};
                headers.forEach((h, i) => obj[h] = (r[i] || "").replace(/^"|"$/g, "")); // rimuove virgolette esterne
                return obj;
            }).filter(r => r[headers[dateIdx]]).sort((a, b) => {
                const da = new Date(a[headers[dateIdx]]);
                const db = new Date(b[headers[dateIdx]]);
                return da - db;
            });

            if (data.length === 0) {
                document.getElementById("output").innerHTML = "Nessuna prenotazione trovata.";
                return;
            }

            showRow();
        }

        function showRow() {
            if (index < 0) index = 0;
            if (index >= data.length) index = data.length - 1;

            const row = data[index];
            let html = "";

            for (const [key, val] of Object.entries(row)) {
                if (key.toLowerCase().includes("note")) {
                    html += `<b>${key}:</b><div class="note-box">${val}</div><br>`;
                } else {
                    html += `<b>${key}:</b> ${val}<br>`;
                }
            }

            document.getElementById("output").innerHTML = `
    ${html}
    <hr>
    <i>Riga ${index + 1} di ${data.length}</i>
  `;
        }

        // üîπ Controlli dei pulsanti
        document.getElementById("done").onclick = () => {
            alert(`‚úÖ Prenotazione segnata come fatta:\n${data[index]["DATA PRENOTAZIONE"]}`);
            next();
        };
        document.getElementById("skip").onclick = next;
        document.getElementById("next").onclick = next;
        document.getElementById("prev").onclick = prev;

        function next() {if (index < data.length - 1) {index++; showRow();} }
        function prev() {if (index > 0) {index--; showRow();} }

        loadSheet();
    </script>

</body>

</html>